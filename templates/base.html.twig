<!DOCTYPE html>
<html lang="fr" data-theme="dark">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>
			{% block title %}
				CHM Saleux - Club d'Halt√©rophilie et de Musculation
			{% endblock %}
		</title>

		<!-- SEO -->
		<meta name="description" content="{% block description %}Club d'Halt√©rophilie et de Musculation de Saleux. √âcole d'halt√©rophilie, formations tous niveaux, comp√©titions. Plus de 25 ans d'exp√©rience.{% endblock %}">
		<meta name="keywords" content="halt√©rophilie, musculation, Saleux, club sportif, comp√©tition, √©cole, entra√Ænement">
		<meta
		name="author" content="CHM Saleux">

		<!-- Open Graph -->
		<meta property="og:title" content="{% block og_title %}CHM Saleux - Club d'Halt√©rophilie et de Musculation{% endblock %}">
		<meta property="og:description" content="{% block og_description %}Rejoignez le CHM Saleux, club d'excellence en halt√©rophilie et musculation. √âcole reconnue, entra√Æneurs dipl√¥m√©s, 25 ans d'exp√©rience.{% endblock %}">
		<meta property="og:type" content="website">
		<meta
		property="og:url" content="{{ app.request.uri }}">

		<!-- Favicon -->
		<link
		rel="icon" type="image/png" href="{{ asset('images/icon.png') }}">

		<!-- Fonts -->
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link
		href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

		<!-- Font Awesome -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

		<!-- Lucide Icons -->
		 <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js" defer></script>
		<link
		rel="stylesheet" href="https://unpkg.com/lucide-static/font/lucide.css"> <!-- ‚úÖ Bootstrap -->
		<link
		href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

		<!-- ‚úÖ CSS global -->
		<link href="{{ asset('css/style.css') }}" rel="stylesheet">
		<link rel="stylesheet" href="{{ asset('css/accueil/nav/nav.css') }}">
		<link rel="stylesheet" href="{{ asset('css/accueil/footer/footer.css') }}"> {% block stylesheets %}{% endblock %}
		</head>

		<body
			class="bg-background text-foreground" style="margin:0; padding:0; width:100%;">

			{# Navbar visible sur toutes les pages sauf si red√©finie vide #}
			{% block navbar %}
				{% include '1_accueil/navbar/navigation.html.twig' %}
			{% endblock %}

			{# Contenu principal #}
			<main style="margin:0; padding:0; width:100%;"> {% block body %}{% endblock %}
				</main>

				{# Footer (avec newsletter) #}
				{% block footer %}
					{% include '1_accueil/footer/footer.html.twig' %}

					{% block newsletter_script %}
						 <script src="{{ asset('js/footer/newsletter.js') }}" defer></script>
					{% endblock %}
				{% endblock %}

				{# ‚úÖ Assistant IA (pas sur login/admin) #}
				{% if app.request.attributes.get('_route') not in ['app_login', 'admin_dashboard'] %}
					{% include '_shared/assistant.html.twig' %}
				{% endif %}

				{# Scripts globaux #}
				 <script src="{{ asset('js/app.js') }}"></script>
				 <script src="{{ asset('js/home/assistant.js') }}" defer></script>

					{% block javascripts %}
					<!-- ========================= -->
					<!-- üìä Librairies Dashboard -->
					<!-- ========================= -->
					 <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script> <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css"rel="stylesheet">  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js" defer></script>

					<!-- ‚úÖ Mini toast -->
						<style>
.toast-mini {
	position: fixed;
	right: 16px;
	bottom: 16px;
	background: #111;
	color: #fff;
	padding: 10px 14px;
	border-radius: 10px;
	box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
	opacity: 0;
	transform: translateY(10px);
	transition: 0.25s;
	z-index: 3000;
}
.toast-mini.show {
	opacity: 1;
	transform: none;
}
					</style>
					 <script>
																																								            window.showToast = (msg) => {
																																								                const t = document.createElement('div');
																																								                t.className = 'toast-mini';
																																								                t.textContent = msg;
																																								                document.body.appendChild(t);
																																								                requestAnimationFrame(() => t.classList.add('show'));
																																								                setTimeout(() => {
																																								                    t.classList.remove('show');
																																								                    setTimeout(() => t.remove(), 200);
																																								                }, 2200);
																																								            };
																																								        </script>

					<!-- ========================= -->
					<!-- ‚úÇÔ∏è CropperJS (Upload Avatar) -->
					<!-- ========================= --> <link
					rel="stylesheet"href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css">  <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js" defer></script>

					<style>
						/* ‚úÖ STYLE GLOBAL DE LA MODALE DE RECADRAGE */
						#avatar-cropper-modal {
							position: fixed;
							inset: 0;
							background: rgba(0, 0, 0, 0.7);
							display: none;
							justify-content: center;
							align-items: center;
							z-index: 2000;
							backdrop-filter: blur(3px);
						}

						#avatar-cropper-modal .modal-content {
							background: #fff;
							padding: 20px;
							border-radius: 16px;
							width: 90%;
							max-width: 420px;
							box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
							text-align: center;
							position: relative;
							animation: popIn 0.25s ease;
						}

						@keyframes popIn {
							from {
								transform: scale(0.9);
								opacity: 0;
							}
							to {
								transform: scale(1);
								opacity: 1;
							}
						}

						#cropper-preview {
							width: 100%;
							max-height: 350px;
							border-radius: 12px;
							object-fit: contain;
						}

						#cropper-live-preview {
							width: 100px;
							height: 100px;
							border-radius: 50%;
							overflow: hidden;
							margin: 15px auto 10px;
							border: 3px solid #e0e0e0;
							background: #f9f9f9;
						}

						#cropper-live-preview img {
							width: 100%;
							height: 100%;
							object-fit: cover;
						}

						.cropper-btns {
							display: flex;
							justify-content: center;
							gap: 10px;
							margin-top: 10px;
						}

						.cropper-btns button {
							border: none;
							border-radius: 8px;
							padding: 8px 14px;
							font-weight: 500;
							cursor: pointer;
							transition: all 0.2s;
						}

						#cropper-save {
							background: #d32f2f;
							color: white;
						}

						#cropper-save:hover {
							background: #b71c1c;
						}

						#cropper-cancel {
							background: #f0f0f0;
						}

						#cropper-cancel:hover {
							background: #e0e0e0;
						}
					</style>

					 <script>
																																								        document.addEventListener("DOMContentLoaded", () => {
																																								            const avatarImg = document.getElementById('user-avatar-img');
																																								            const fileInput = document.getElementById('avatar-file-input');
																																								            if (!avatarImg || !fileInput) return;
																																								
																																								            let cropper;
																																								            const modal = document.createElement("div");
																																								            modal.id = "avatar-cropper-modal";
																																								            modal.innerHTML = `
																																								                <div class="modal-content">
																																								                    <h5 style="font-weight:600; margin-bottom:12px;">Ajustez votre photo</h5>
																																								                    <div id="cropper-container">
																																								                        <img id="cropper-preview" alt="Pr√©visualisation"/>
																																								                    </div>
																																								                    <div id="cropper-live-preview"><img id="cropper-mini" /></div>
																																								                    <div class="cropper-btns">
																																								                        <button id="cropper-save">Enregistrer</button>
																																								                        <button id="cropper-cancel">Annuler</button>
																																								                    </div>
																																								                </div>
																																								            `;
																																								            document.body.appendChild(modal);
																																								
																																								            const previewImg = modal.querySelector("#cropper-preview");
																																								            const miniPreview = modal.querySelector("#cropper-mini");
																																								            const btnSave = modal.querySelector("#cropper-save");
																																								            const btnCancel = modal.querySelector("#cropper-cancel");
																																								
																																								            fileInput.addEventListener("change", e => {
																																								                const file = e.target.files[0];
																																								                if (!file) return;
																																								                const reader = new FileReader();
																																								                reader.onload = evt => {
																																								                    modal.style.display = "flex";
																																								                    previewImg.src = evt.target.result;
																																								                    if (cropper) cropper.destroy();
																																								                    cropper = new Cropper(previewImg, {
																																								                        aspectRatio: 1,
																																								                        viewMode: 2,
																																								                        background: false,
																																								                        dragMode: 'move',
																																								                        crop(event) {
																																								                            const canvas = cropper.getCroppedCanvas({ width: 100, height: 100 });
																																								                            miniPreview.src = canvas.toDataURL('image/jpeg');
																																								                        }
																																								                    });
																																								                };
																																								                reader.readAsDataURL(file);
																																								            });
																																								
																																								            btnCancel.addEventListener("click", () => {
																																								                modal.style.display = "none";
																																								                fileInput.value = "";
																																								                if (cropper) cropper.destroy();
																																								            });
																																								
																																								            btnSave.addEventListener("click", async () => {
																																								                const canvas = cropper.getCroppedCanvas({ width: 300, height: 300 });
																																								                canvas.toBlob(async blob => {
																																								                    const formData = new FormData();
																																								                    formData.append("avatar", blob, "avatar.jpg");
																																								                    formData.append("_csrf_token", "{{ csrf_token('profile_image') }}");
																																								
																																								                    try {
																																								                        const res = await fetch("{{ path('profile_photo_upload') }}", {
																																								                            method: "POST",
																																								                            body: formData
																																								                        });
																																								                        const data = await res.json();
																																								                        if (data.status === "ok") {
																																								                            avatarImg.src = data.dataUrl;
																																								                            showToast("Photo enregistr√©e ‚úÖ");
																																								                        } else {
																																								                            alert("Erreur : " + data.error);
																																								                        }
																																								                    } catch (e) {
																																								                        alert("Erreur r√©seau");
																																								                    }
																																								
																																								                    modal.style.display = "none";
																																								                    cropper.destroy();
																																								                    fileInput.value = "";
																																								                }, "image/jpeg");
																																								            });
																																								        });
																																								        </script>

					{% include '_partials/modal_auth.html.twig' %}
					<link rel="stylesheet" href="{{ asset('css/_partials/modal.css') }}">
				 <script src="{{ asset('js/_partials/modal_register.js') }}"></script>

					<!-- ‚úÖ Script Cloudflare Turnstile (charg√© globalement une seule fois) -->
					 <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>


				{% endblock %}
			</body>
		</html>
